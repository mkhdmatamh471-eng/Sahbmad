import asyncio
import os
import re
import logging
import threading
from flask import Flask

# --- ุงุณุชูุฑุงุฏุงุช Telethon ---
from telethon import TelegramClient, events
from telethon.sessions import StringSession

# ุฅุนุฏุงุฏ ุงูุณุฌูุงุช ุจุดูู ูุจุณุท ููุงุถุญ
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')

# ูุญุงููุฉ ุงุณุชูุฑุงุฏ ุงูุฅุนุฏุงุฏุงุช ูู ููู config.py
try:
    from config import normalize_text, CITIES_DISTRICTS
except ImportError:
    def normalize_text(t):
        # ุฏุงูุฉ ุจุณูุทุฉ ูุชูุญูุฏ ุงููุต ูู ุญุงู ููุฏุงู ููู config
        t = t.replace("ุฃ", "ุง").replace("ุฅ", "ุง").replace("ุข", "ุง").replace("ุฉ", "ู")
        return t.strip().lower()
    CITIES_DISTRICTS = {}

# --- ุฅุนุฏุงุฏุงุช ุงูุญุณุงุจ ูุงูุจูุช ---
API_ID = os.environ.get("API_ID", "36360458")
API_HASH = os.environ.get("API_HASH", "daae4628b4b4aac1f0ebfce23c4fa272")
# โ๏ธ ุงูุชุจู: ููุฏ ุฌูุณุฉ Pyrogram ูุง ูุนูู ููุง. ูู ุจุชูููุฏ ููุฏ ุฌุฏูุฏ ุฃู ุชุณุฌูู ุงูุฏุฎูู ูุฃูู ูุฑุฉ.
SESSION_STRING = os.environ.get("TELETHON_SESSION", "1BJWap1sBuyfIQ9CyhEsZ-f9Xo4W1pr24lihTxGhG_Lrkv25fXoe_HFNLnH0KFqQiXYsMuR_8gzff_3pZLDXF4Q8VUCAQdH_TA_x4z7P8byAP4gTJUc6SNucFy6bznjDHSBnJZht4rrrrwUU9wSeQvsvmP0imFJMFhutiX91CxHYLZVWivexnRXb5h8r_0szwlll1-nbULa7yTc7zx7R2AxcpwRGhGfDCz75HfAKx-YJ9LJZPqU5_dEvyFoC2LssEakTy_gl2tgU9Hy2dLq8HL6Bu-K6GugoAZ6tC83znjckwk_DgWeU9kwOYOms3amFf54JdIf7ML25n9zSkM9WaSR-C_9FD3n4=") 
BOT_USERNAME = "Mishwariibot" 
# ุขูุฏู ุงููุฑูุจ ุงูุฎุงุต ุจุงูุณุงุฆููู (ุชุฃูุฏ ูู ูุชุงุจุชู ุจุดูู ุตุญูุญุ ูุจุฏุฃ ุจู -100)
PRIVATE_DRIVERS_GROUP_ID = -1005136174968 

client = TelegramClient(StringSession(SESSION_STRING), API_ID, API_HASH)

# --- ูุญุฑู ุงูููุชุฑุฉ ุงููุฏูู ---
# ูุงุฆูุฉ ุงููููุงุช ุงูุณูุฏุงุก (ุชููุน ุงูุณุญุจ)
EXCLUDE_KEYWORDS = [
    # ูููุงุช ุงูุฑุณุงูุฉ ุงูุชุนุฑูููุฉ ูุฅุนูุงูุงุช ุงูุณุงุฆููู
    "ุฃุณุฑุน ุฎุฏูู", "ุงุทูุจ ูุดูุงุฑู", "ุฃูุฑุจ ุณุงุฆู", "ูููุนู", "ุฃุจุฏุฃ ูุดูุงุฑู", "ุจุฃุณุฑุน ููุช",
    "ุชุฐููุฑ ุชููุงุฆู", "ุฎุฏูุฉ ุชูุตูู ุงููุฏููุฉ ุงููููุฑุฉ", "ูู ุชุญุชุงุฌ ุฅูู ูุดูุงุฑ ุณุฑูุน",
    "ูุญู ููุง ูุฎุฏูุชู", "ุนูู ูุฏุงุฑ ุงูุณุงุนุฉ", "ูุทูุจ ูุงุจุชู ููุฑุงู",   
    "ูุชูุงุฌุฏ", "ูุชุงุญ", "ุดุบุงู", "ุฌุงูุฒ", "ุฃุณุนุงุฑูุง", "ุงุณุนุงุฑูุง", "ุณูุงุฑุฉ ูุธููุฉ", 
    "ุชูุตูู ูุดุงููุฑ", "ุฃูุตู", "ุงูุตู", "ุจุฎุฏูุชูู", "ุฃุณุชูุจู", "ุงุณุชูุจู", "ูุงุจุชู ููุซูู",
     
    # ูููุงุช ุงูุชุนููุจ ูุงูุฎุฏูุงุช ูุงูุฅูุงูุงุช
    "ูุฑูุจ ูููู", "ุจูุงุบ ูุฑูุจ", "ุฎุฑูุฌ ููุงุฆู", "ุชุฌุฏูุฏ ุงูุงูุฉ", "ูุฑุช ุนูู", 
    "ุงุณุชุฎุฑุงุฌ ุชุงุดูุฑุงุช", "ุญุฌุจ ุงููุฎุงููุงุช", "ุชุนุฏูู ุงููููู", "ุชุนุฏูู ูููู",
    
    # ูููุงุช ุงูุฅุฏุงุฑุฉ ูุงููุฑูุจุงุช
    "ุฅุฏุงุฑุฉ ุงููุฑูุจ", "ุงุฏุงุฑุฉ ุงููุฑูุจ", "ุญุฑุตุง ููุง", "ุณูุงูุชูู", "ุงูุชุจู", "ูุฑุดุญูู ููู", 
    "ููุซูู ูู", "ุงููุฑุดุญูู", "ููุงุนุฏ ุงููุฑูุจ", "ููุงููู ุงููุฑูุจ",
    
    # ูููุงุช ุงูุณููููุงุช
    "ุณูููู", "ุณููููุงุช", "ุนุฐุฑ ุทุจู", "ุงุนุฐุงุฑ ุทุจูู", "ุฃุนุฐุงุฑ ุทุจูุฉ", "ุงุฌุงุฒุฉ ูุฑุถูุฉ", 
    "ููุตุฉ ุตุญุชู", "ุตุญุชู", "ุชูุฒูู ุงุนุฐุงุฑ", "ูุฑุถู", "ูุฑูุถ",
    
    # ูููุงุช ุงููุตุจ ุงููุงูู ูุงูุงุณุชุซูุงุฑ
    "ุงุณุชุซูุงุฑ", "ุงุฑุจุงุญ", "ุฃุฑุจุงุญ", "ุชุฏุงูู", "ุนููุงุช ุฑูููุฉ", "ุฏููุงุฑ", "ููุตุฉ", 
    "ุงุฑุจุญ", "ุฏุฎู ุฅุถุงูู", "ุนูู ุนู ุจุนุฏ", "ุชุญููู ูุจุงูุบ", "ุชูุฒูุน ุฌูุงุฆุฒ",
    
    # ูููุงุช ุงูุชุนููุจ ูุงูุฎุฏูุงุช ุงูุนุงูุฉ
    "ูุนูุจ", "ุชุนููุจ", "ุงุณุชูุฏุงู", "ุชูุงููุถ", "ุฅูุฌุงุฒ", "ุงูุฌุงุฒ", "ุชุณุฏูุฏ ูุฎุงููุงุช", 
    "ูุฑูุถ", "ูุฑุถ", "ุชูููู", "ุจูู", "ููู ููุงูุฉ", "ุชุนุฏูู ูููุฉ",
    
    # ุงูุฅุนูุงูุงุช ุงูุนุงูุฉ ูุงูุฑูุงุจุท
    "ุงุนูุงู", "ุฅุนูุงู", "ูุณุงุฌ", "t.me", "http", ".com", "ุฑุงุจุท", "ูุฑูุจูุง", "ุงูุถููุง",

    # ูููุงุช ุงูุฑุณุงุฆู ุบูุฑ ุงููุงุฆูุฉ ูุงููุตุจ ุจุงูุจุทุงูุงุช
    "ุฎุงุถุนุงุช", "ุนูุงุช", "ุนูููุชู", "ูุงูู ูุงุฑุฏ", "ุจุทุงูุฉ ุณูุง", "ุงุซุจุงุชู ุจูุจุงูู", "ุจููุงุจู", "ุฃููุฑ ูู ุทูุจู",

    # ูููุงุช ุงูุงุณุชูุณุงุฑุงุช ูุงูุชูุธูู
    "ุชุนุฑููู", "ุงููู ูุนุฑู", "ุชูุธููุฉ", "ููุธููู", "ุงูุฏู",

    # ูููุงุช ุงูุณุงุฆููู ุงููุชูุฑุบูู
    "ูุงุถู", "ูุชูุฑุบ ูููุดุงููุฑ", "ุงู ูุดูุงุฑ", "ุชูุถู",

    # --- ุฅุถุงูุฉ ุฌุฏูุฏุฉ: ูููุงุช ุนุงููุฉ (ูุฑูุฏ/ูุจุบู) ---
    "ุจุฏู", "ูุจู", "ุชุจู", "ุชุจุบู"
]

# ูููุงุช ุงูุทูุจ (ูุฌุจ ูุฌูุฏ ูุงุญุฏุฉ ูููุง ุนูู ุงูุฃูู)
# 1. ูููุงุช ุงูุทูุจ (ุฅุถุงูุฉ ุงูุตูุบ ุงูุฌุฏูุฏุฉ ุงูุชู ุฐูุฑุชูุง)
ORDER_INDICATORS = [
    # ุงูุตูุบ ุงูุณุนูุฏูุฉ ูุงูุฎููุฌูุฉ ุงูุฏุงุฑุฌุฉ
    "ุงุจู", "ุงุจุบู", "ุงุจุบู", "ุงุจุบุง", "ุฃุจุบู", "ุฃุจุบุง", "ูุจู", "ุชุจุบู", "ุชุจุบุง",
    "ูุญุชุงุฌ", "ุงุญุชุงุฌ", "ุฃุญุชุงุฌ", "ุนูุฒ", "ุนุงูุฒ", "ุนุงูุฒ", "ุฃุฏูุฑ", "ุงุฏูุฑ", 
    "ูุทููุจ", "ุจูู", "ูู ูุดูุงุฑ", "ูู ุชูุตูู", "ุงุฑุฎุต", "ุฃุฑุฎุต",

    # ุตูุบ ุงูุณุคุงู ุนู ุชููุฑ ุงูุฎุฏูุฉ (Pings)
    "ูู ุงุญุฏ", "ุงุญุฏ ููุตู", "ูู ููุตู", "ูู ูุงุจุชู", "ูู ุณูุงู", "ููู ููุฏููู", 
    "ูู ููุฏููู", "ููู ููุตู", "ุงุญุฏ ูุฑูุญ", "ุงุญุฏ ุญูู", "ูู ุณูุงุฑุฉ", "ูู ุณูุงุฑู",

    # ุตูุบ ุงูุงุณุชุนุฌุงู ูุงูุทูุจ ุงููุจุงุดุฑ
    "ุชูุตููุฉ", "ุชูุตููู", "ูุดูุงุฑ", "ูุดุงููุฑ", "ุฏุฑุจ", "ุทุฑูู", "ุทุฑููู", 
    "ูุณุชุนุฌู", "ุงูุงู", "ุงูุญูู", "ุญุงูุง", "ููุฑุง", "ุถุฑูุฑู",

    # ุตูุบ ุงูุนููุฏ ูุงููุฏุงุฑุณ (ุงูููุงุช ุทูููุฉ ุงููุฏู)
    "ุงุฏูุฑ ูููู", "ุงุฏูุฑ ุณูุงู", "ูุทููุจ ููู", "ุงุฑูุฏ", "ุฃุฑูุฏ", "ุงุฑุบุจ", "ุฃุฑุบุจ",
    "ูู ููุฏุฑ", "ููุฏุฑ ููุตู", "ูุชููุฑ", "ูุชููุฑ ุณูุงุฑุฉ", "ููู ุนูุฏู"
]


# 2. ุฃููุงุน ุงูุฎุฏูุงุช (ุฅุถุงูุฉ ุงูุฃุบุฑุงุถ ูุงูุณูุงุฑุงุช ุงููุจูุฑุฉ)
SERVICE_TYPES = [
    # ูุณููุงุช ุงูุฎุฏูุฉ ุงูุนุงูุฉ
    "ุณูุงู", "ุณุงุฆู", "ุชูุตูู", "ูุดูุงุฑ", "ูุดุงููุฑ", "ููุฏููู", "ููุตููู", "ูุงุฎุฐูู",
    "ููู", "ูุงุจุชู", "ููุฏูุจ", "ุชูุตููุฉ", "ุชูุตููู", "ุฏุฑุจ", "ุทุฑูู", "ุฑุฏ", "ุฑุฏูุฏ",

    # ุฃููุงุน ุงููููููุงุช
    "ุงุบุฑุงุถ", "ุฃุบุฑุงุถ", "ุนูุด", "ุจุถุงุนุฉ", "ุจุถุงุนู", "ุทุฑุฏ", "ุทูุจูู", "ุทูุจูุฉ", 
    "ุฃูุงูุฉ", "ุงูุงูู", "ุฐุจูุญุฉ", "ุฐุจูุญู", "ููุงุถู", "ุฃูู", "ุงูู", "ุงุซุงุซ", "ุฃุซุงุซ",

    # ุฃููุงุน ุงูุณูุงุฑุงุช (ุชููุฏ ูู ุชุญุฏูุฏ ููุน ุงูุทูุจ)
    "ุณูุงุฑุฉ", "ุณูุงุฑู", "ูุงู", "ุฏุจุงุจ", "ูููุช", "ุณุทุญุฉ", "ุณุทุญู", "ุฏููุง", "ุจุงุต", 
    "ูุงููููุณ", "ุฌูุณ", "ุตุงููู", "ุณูุงุฑุฉ ูุจูุฑุฉ", "ุณูุงุฑู ูุจูุฑู", "ุฎุตูุตู", "ุชุงูุณู",

    # ูุฌูุงุช ูุฃูุงูู (ุชุนุชุจุฑ ุฎุฏูุฉ ุจุญุฏ ุฐุงุชูุง)
    "ุงููุทุงุฑ", "ุงูุญุฑู", "ุงููุทุงุฑ", "ุงููุญุทุฉ", "ุงููุญุทู", "ุฌุงูุนุฉ", "ุฌุงูุนู", "ูุฏุฑุณุฉ", "ูุฏุฑุณู",
    "ูููุฉ", "ูููู", "ุณูู", "ููู", "ุฏูุงู", "ูุณุชุดูู", "ูุณุชูุตู", "ุนูุงุฏุฉ", "ุนูุงุฏู",

    # ุงูุณูุฑ ุจูู ุงููุฏู
    "ุฌุฏู", "ุฌุฏุฉ", "ููุฉ", "ููู", "ุงูุฑูุงุถ", "ุงููุตูู", "ููุจุน", "ุณูุฑ", "ุฎุท"
]


# ---------------------------------------------------------
# ุงููุญุฑู ุงููุฏูู ุงููุทูุฑ (V2.0)
# ---------------------------------------------------------
def analyze_message_manual(text):
    if not text or len(text) < 5 or len(text) > 500: 
        return False

    clean_text = normalize_text(text)

    # 1. ูุญุต ุงููุณุชุจุนุฏุงุช (ุงููููุงุช ุงูุณูุฏุงุก)
    if any(k in clean_text for k in EXCLUDE_KEYWORDS):
        return False

    # 2. ูุญุต ููุท ุงููุณุงุฑ ุงููุทูุฑ (ูู ... ุฅูู/ุงูู/ุงูู/ูู)
    # ูุฏุนู: "ูู ุจุฆุฑ ุนุซูุงู ุงูู ุญู ุงููุจูุชูู"
    route_pattern = r"(^|\s)ูู\s+.*?\s+(ุฅูู|ุงูู|ุงูู|ูู|ูููุทุงุฑ|ููุญุฑู|ููุฌุงูุนุฉ)(\s|$)"
    if re.search(route_pattern, clean_text):
        return True 

    # 3. ูุญุต ุงูุฌูุน ุจูู (ูููุฉ ุทูุจ + ููุน ุฎุฏูุฉ)
    # ูุฏุนู: "ุงุญุชุงุฌ" + "ุชูุตูู" ุฃู "ุงุจู" + "ุณูุงุฑุฉ"
    has_order_word = any(word in clean_text for word in ORDER_INDICATORS)
    has_service_word = any(word in clean_text for word in SERVICE_TYPES)

    if has_order_word and has_service_word:
        return True

    # 4. ูุญุต ูููุงุช ุงูุนููุฏ ูุงูุฏูุงูุงุช
    contract_words = ["ุดูุฑู", "ุนูุฏ", "ูุฏุงุฑุณ", "ุทุงูุจุงุช", "ููุธูุงุช", "ุฏูุงู", "ูุดุงููุฑ"]
    if any(word in clean_text for word in contract_words) and has_order_word:
        return True

    return False

# --- ูุนุงูุฌุฉ ุงูุฑุณุงุฆู ---
@client.on(events.NewMessage(incoming=True))
async def handle_new_messages(event):
    # ุงูุชุฃูุฏ ูู ุฃู ุงูุฑุณุงูุฉ ูู ูุฌููุนุฉ ูููุณ ุฎุงุต
    if not event.is_group: 
        return

    try:
        text = event.raw_text
        if not text: 
            return

        # ูุญุต ูุทุงุจูุฉ ุงูุฑุณุงูุฉ ูุดุฑูุท ุงูููุต
        if analyze_message_manual(text):
            print(f"๐ฏ [ููุต] ุทูุจ ูุทุงุจู: {text[:40]}...")

            # 1. ุชุญุฏูุฏ ุงูุญู (ุงูููุทูุฉ)
            found_d = "ุนุงู"
            text_c = normalize_text(text)
            for city, districts in CITIES_DISTRICTS.items():
                for d in districts:
                    if normalize_text(d) in text_c:
                        found_d = d
                        break

            # 2. ุฌูุจ ุจูุงูุงุช ุงููุฑุณู (ุงูุนููู)
            sender = await event.get_sender()
            sender_id = sender.id if sender else 0
            sender_name = getattr(sender, 'first_name', 'ุนููู')
            username = getattr(sender, 'username', None)

            # 3. ุชุฌููุฒ ุงูุฑูุงุจุท (ูุชู ุฅุฑุณุงููุง ููุจูุช ุงูููุฒุน ููุฎุชุงุฑ ุงูุฃูุณุจ)
            user_url = f"https://t.me/{username}" if username else "None"

            # ุชูุธูู ุงูุขูุฏู ูู -100 ูุฅูุดุงุก ุฑุงุจุท ุงูุฑุณุงูุฉ (Message Link)
            chat_id_clean = str(event.chat_id).replace("-100", "")
            msg_link = f"https://t.me/c/{chat_id_clean}/{event.id}"

            # 4. ุตูุงุบุฉ "ุทุฑุฏ ุงูุจูุงูุงุช" ุงููุฑุณู ููุจูุช ุงูููุฒุน
            # ููุงุญุธุฉ: ูุณุชุฎุฏู ูุณู #ORDER_DATA# ููุนุฑู ุงูุจูุช ุฃู ูุฐู ุฑุณุงูุฉ ุชุญููู ุทูุจุงุช
            order_payload = (
                f"#ORDER_DATA#\n"
                f"DISTRICT:{found_d}\n"
                f"CUST_NAME:{sender_name}\n"
                f"CONTENT:{text}\n"
                f"USERNAME:{user_url}\n"
                f"MSG_LINK:{msg_link}"
            )

            # 5. ุฅุฑุณุงู ุงูุจูุงูุงุช ููุจูุช ุงูููุฒุน (ุงูุฑุณูู)
            # ุงุณุชุจุฏู 'Your_Bot_Username' ุจูุนุฑู ุจูุชู ุงูููุฒุน (ุจุฏูู @ ุฃู ุจูุง ุญุณุจ ุงูููุชุจุฉ)
            try:
                # ููุถู ุงุณุชุฎุฏุงู ุงููุนุฑู (Username) ููุจูุช ููุง
                await client.send_message('Mishwariibot', order_payload)
                print(f"โ ุชู ุชุญููู ุงูุทูุจ ุจูุฌุงุญ ููุจูุช ุงูููุฒุน")

            except Exception as e:
                print(f"โ ูุดู ุงูุชุญููู ููุจูุช ุงูููุฒุน: {e}")
                # ุฎูุงุฑ ุงุญุชูุงุทู: ุงูุฅุฑุณุงู ูููุฑูุจ ุงูุฎุงุต ูุจุงุดุฑุฉ ูู ุญุงู ุชุนุทู ุงูุจูุช ุงูููุฒุน
                try:
                    await client.send_message(-1005136174968, "โ๏ธ ูุดู ุงูุชุญููู ููุจูุชุ ุฅุฑุณุงู ุงุญุชูุงุทู:\n" + order_payload)
                except:
                    pass

    except Exception as e:
        print(f"โ๏ธ ุฎุทุฃ ุนุงู ูู ุงูุฏุงูุฉ: {e}")

# ุชุฃูุฏ ุฃู ูุฐุง ุงูุณุทุฑ ูุจุฏุฃ ูู ุจุฏุงูุฉ ุงูุณุทุฑ ุชูุงูุงู (ุจุฏูู ุฃู ูุณุงูุงุช ูุจูู)
app = Flask(__name__)
@app.route('/')
def home(): return "Radar Online", 200

def run_flask():
    app.run(host='0.0.0.0', port=8080)

# --- ุงูุชุดุบูู ุงูุฑุฆูุณู ---
async def main():
    print("๐ก ุฌุงุฑู ุงูุงุชุตุงู ุจุชููุฌุฑุงู...")
    await client.start()

    me = await client.get_me()
    print(f"โ ูุชุตู ูู: {me.first_name}")

    print("๐ ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฌููุนุงุช...")
    await client.get_dialogs()

    print("๐ ุงูุฑุงุฏุงุฑ ูุนูู ุงูุขู ูู ุชูุฑููุณ..")
    await client.run_until_disconnected()

if __name__ == "__main__":
    threading.Thread(target=run_flask, daemon=True).start()
    loop = asyncio.get_event_loop()
    try:
        loop.run_until_complete(main())
    except KeyboardInterrupt:
        print("๐ ุชููู.")