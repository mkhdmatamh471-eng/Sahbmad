import re
import os
import asyncio

# --- 1. إصلاح تعريف الروابط والمتغيرات ---
# جلب الرابط من البيئة، وإذا لم يوجد نضع قيمة فارغة لتجنب الـ NameError

BOT_TOKEN = os.environ.get("BOT_TOKEN", "8498451295:AAGt1R7THllSjYtEe5hvIEPnPhRkS_iBcnU")


# --- 2. إعدادات الأحياء (المدينة المنورة) ---
CITIES_DISTRICTS = {
    "المدينة المنورة": [
        # --- الأحياء السكنية (تم إضافة الخليل والنصر والسكب والقصواء) ---
        "أبو مرخة", "أبيار علي", "الأسواف", "البخاري", "الإسكان", "البحر", 
        "البدراني", "الجمعة", "الجرف", "الحزام", "الحمراء", "الخاتم", "الخالدية", 
        "الدائرة", "الدائري", "الدويخله", "الدويمة", "الدعيثة", "الرانونا", "الرناونة", 
        "الربوة", "السيح", "الشروق", "الشرق", "الشهداء", "الشيبية", "الظاهرة", 
        "العاقول", "العالية", "العوالي", "العريض", "العزيزية", "العصبة", 
        "العنابس", "العنبرية", "العيون", "الفتح", "القبلتين", "القارات", "المبعوث", 
        "المطار", "المغيسله", "الملك فهد", "الملك فيصل", "المناخة", "المصانع", 
        "النور", "النبلاء", "النقيع", "النقمي", "الهجرة", "الواحة", "الوادي", 
        "بئر الماشي", "بئر عثمان", "باقدو", "بني حارثة", "بني ظفر", "تلال علي", 
        "تلال", "حمراء الأسد", "دفاع", "ذو الحليفة", "رهط", "سيد الشهداء", 
        "سلطانة", "سكة الحديد", "السقيا", "شظاة", "شوران", "عروة", "قباء", 
        "قربان", "مخطط التلال", "مهزور", "وعيرة", "العصيبي", "تلعة الهبوب", 
        "الزهراء", "الفيحاء", "المنار", "سكن الحرس", "السديري", "المطار القديم",
        "السكب", "الورود", "الراية", "القصواء", "الهدى", "الروابي", "الريان",
        "الجابرة", "الرويعي", "المطار الجديد", "المزيني", "المعذر", 
        "الخليل", "حي الخليل", "النصر", "حي النصر", # تم الإضافة هنا
        "كتانة", "البركة", "الجسر", "المخطط", "حي الملك فهد", "حي المطار",

        # --- المعالم والمرافق الحيوية ---
        "الحرم", "المسجد النبوي", "مسجد قباء", "مسجد القبلتين", "الميقات", "ابيار علي",
        "محطة القطار", "قطار الحرمين", "المحطة", "سابتكو", "النقل الجماعي",
        "جامعة طيبة", "الجامعة الإسلامية", "الكلية التقنية", "جامعة الامير مقرن",

        # --- المولات والأسواق ---
        "النور مول", "الراشد مول", "العالية مول", "المنار مول", "مزايا مول", 
        "توب تن", "سوق الخضار", "سوق التمور", "الحجاز مول", "سوق البدر",

        # --- المستشفيات ---
        "مستشفى الملك فهد", "مستشفى أحد", "المستشفى العسكري", "مستشفى الحرس",
        "مستشفى الولادة", "مستشفى الميقات", "المواساة", "مستشفى الدار", "الطب الدولي",

        # --- المناطق المركزية ---
        "المنطقة المركزية", "المركزية", "باب السلام", "باب المجيدي", "فندق", "أجنحة"
    ]
}

# --- 3. دالة معالجة النصوص (المحسنة) ---
def normalize_text(text):
    """تنظيف وتوحيد النصوص العربية لزيادة دقة البحث"""
    if not text: return ""
    text = text.strip().lower()
    text = re.sub(r"[\u064B-\u0652]", "", text) # إزالة التشكيل
    
    replacements = {
        "أ": "ا", "إ": "ا", "آ": "ا",
        "ة": "ه", "ى": "ي", "ئ": "ي", "ؤ": "و"
    }
    for old, new in replacements.items():
        text = text.replace(old, new)
    
    # إزالة ال التعريف من الكلمات الطويلة لزيادة مطابقة الأحياء
    words = text.split()
    clean_words = [w[2:] if w.startswith("ال") and len(w) > 3 else w for w in words]
    return " ".join(clean_words)

# ملاحظة: تم حذف دوال قاعدة البيانات (init_db, pool) لأن الرادار لا يحتاجها 
# ليعمل الملف كـ Config صافي وخفيف.
