import re
import os
import asyncio

# --- ØªØ¹Ø±ÙŠÙ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
BOT_TOKEN = "8498451295:AAGt1R7THllSjYtEe5hvIEPnPhRkS_iBcnU"
# Ù†Ù‚ÙˆÙ… Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© (Environment Variables) Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†
# ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù…ÙƒØªØ¨Ø© psycopg2 (Ø®Ø§ØµØ© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ Render/Heroku)
if DB_URL and DB_URL.startswith("postgres://"):
    DB_URL = DB_URL.replace("postgres://", "postgresql://", 1)

# Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ù…Ø¬Ù…Ø¹
db_pool = None



# --- 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ (Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©) ---
# ØªÙ… ØªØ±ØªÙŠØ¨Ù‡Ø§ ÙˆØªÙ†Ø¸ÙŠÙÙ‡Ø§ Ù„Ø¶Ù…Ø§Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© Ø£Ø¯Ù‚
CITIES_DISTRICTS = {
    "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©": [
        # --- Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ Ø§Ù„Ø³ÙƒÙ†ÙŠØ© (ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ) ---
        "Ø£Ø¨Ùˆ Ù…Ø±Ø®Ø©", "Ø£Ø¨ÙŠØ§Ø± Ø¹Ù„ÙŠ", "Ø§Ù„Ø£Ø³ÙˆØ§Ù", "Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ", "Ø§Ù„Ø¥Ø³ÙƒØ§Ù†", "Ø§Ù„Ø¨Ø­Ø±", 
        "Ø§Ù„Ø¨Ø¯Ø±Ø§Ù†ÙŠ", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø¬Ø±Ù", "Ø§Ù„Ø­Ø²Ø§Ù…", "Ø§Ù„Ø­Ù…Ø±Ø§Ø¡", "Ø§Ù„Ø®Ø§ØªÙ…", "Ø§Ù„Ø®Ø§Ù„Ø¯ÙŠØ©", 
        "Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©", "Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ", "Ø§Ù„Ø¯ÙˆÙŠØ®Ù„Ù‡", "Ø§Ù„Ø¯ÙˆÙŠÙ…Ø©", "Ø§Ù„Ø¯Ø¹ÙŠØ«Ø©", "Ø§Ù„Ø±Ø§Ù†ÙˆÙ†Ø§", "Ø§Ù„Ø±Ù†Ø§ÙˆÙ†Ø©", 
        "Ø§Ù„Ø±Ø¨ÙˆØ©", "Ø§Ù„Ø³ÙŠØ­", "Ø§Ù„Ø´Ø±ÙˆÙ‚", "Ø§Ù„Ø´Ø±Ù‚", "Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡", "Ø§Ù„Ø´ÙŠØ¨ÙŠØ©", "Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©", 
        "Ø§Ù„Ø¹Ø§Ù‚ÙˆÙ„", "Ø§Ù„Ø¹Ø§Ù„ÙŠØ©", "Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ", "Ø§Ù„Ø¹Ø±ÙŠØ¶", "Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ©", "Ø§Ù„Ø¹ØµØ¨Ø©", 
        "Ø§Ù„Ø¹Ù†Ø§Ø¨Ø³", "Ø§Ù„Ø¹Ù†Ø¨Ø±ÙŠØ©", "Ø§Ù„Ø¹ÙŠÙˆÙ†", "Ø§Ù„ÙØªØ­", "Ø§Ù„Ù‚Ø¨Ù„ØªÙŠÙ†", "Ø§Ù„Ù‚Ø§Ø±Ø§Øª", "Ø§Ù„Ù…Ø¨Ø¹ÙˆØ«", 
        "Ø§Ù„Ù…Ø·Ø§Ø±", "Ø§Ù„Ù…ØºÙŠØ³Ù„Ù‡", "Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯", "Ø§Ù„Ù…Ù„Ùƒ ÙÙŠØµÙ„", "Ø§Ù„Ù…Ù†Ø§Ø®Ø©", "Ø§Ù„Ù…ØµØ§Ù†Ø¹", 
        "Ø§Ù„Ù†ÙˆØ±", "Ø§Ù„Ù†Ø¨Ù„Ø§Ø¡", "Ø§Ù„Ù†Ù‚ÙŠØ¹", "Ø§Ù„Ù†Ù‚Ù…ÙŠ", "Ø§Ù„Ù‡Ø¬Ø±Ø©", "Ø§Ù„ÙˆØ§Ø­Ø©", "Ø§Ù„ÙˆØ§Ø¯ÙŠ", 
        "Ø¨Ø¦Ø± Ø§Ù„Ù…Ø§Ø´ÙŠ", "Ø¨Ø¦Ø± Ø¹Ø«Ù…Ø§Ù†", "Ø¨Ø§Ù‚Ø¯Ùˆ", "Ø¨Ù†ÙŠ Ø­Ø§Ø±Ø«Ø©", "Ø¨Ù†ÙŠ Ø¸ÙØ±", "ØªÙ„Ø§Ù„ Ø¹Ù„ÙŠ", 
        "ØªÙ„Ø§Ù„", "Ø­Ù…Ø±Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¯", "Ø¯ÙØ§Ø¹", "Ø°Ùˆ Ø§Ù„Ø­Ù„ÙŠÙØ©", "Ø±Ù‡Ø·", "Ø³ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø¯Ø§Ø¡", 
        "Ø³Ù„Ø·Ø§Ù†Ø©", "Ø³ÙƒØ© Ø§Ù„Ø­Ø¯ÙŠØ¯", "Ø§Ù„Ø³Ù‚ÙŠØ§", "Ø´Ø¸Ø§Ø©", "Ø´ÙˆØ±Ø§Ù†", "Ø¹Ø±ÙˆØ©", "Ù‚Ø¨Ø§Ø¡", 
        "Ù‚Ø±Ø¨Ø§Ù†", "Ù…Ø®Ø·Ø· Ø§Ù„ØªÙ„Ø§Ù„", "Ù…Ù‡Ø²ÙˆØ±", "ÙˆØ¹ÙŠØ±Ø©", "Ø§Ù„Ø¹Ø§Ù‚ÙˆÙ„", "Ø§Ù„ØºØ§Ø¨Ø©", "Ø§Ù„Ù…ØµØ§Ù†Ø¹",
        "Ø§Ù„Ø¹ØµÙŠØ¨ÙŠ", "ØªÙ„Ø¹Ø© Ø§Ù„Ù‡Ø¨ÙˆØ¨", "Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯", "Ø§Ù„Ø¹ÙŠÙˆÙ†", "Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡", "Ø§Ù„ÙÙŠØ­Ø§Ø¡",
        "Ø§Ù„Ù…Ù†Ø§Ø±", "Ø³ÙƒÙ† Ø§Ù„Ø­Ø±Ø³", "Ø§Ù„Ø³Ø¯ÙŠØ±ÙŠ", "Ø§Ù„Ø¯ÙˆÙŠÙ…Ø©", "Ø§Ù„Ù…Ø·Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…",

        # --- Ø§Ù„Ù…Ø¹Ø§Ù„Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¬Ø¯ Ø§Ù„ÙƒØ¨Ø±Ù‰ ---
        "Ø§Ù„Ø­Ø±Ù…", "Ø§Ù„Ù…Ø³Ø¬Ø¯ Ø§Ù„Ù†Ø¨ÙˆÙŠ", "Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø­Ø±Ù…", "Ù…Ø³Ø¬Ø¯ Ù‚Ø¨Ø§Ø¡", "Ù…Ø³Ø¬Ø¯ Ø§Ù„Ù‚Ø¨Ù„ØªÙŠÙ†", 
        "Ù…Ø³Ø¬Ø¯ Ø§Ù„Ù…ÙŠÙ‚Ø§Øª", "Ø¢Ø¨Ø§Ø± Ø¹Ù„ÙŠ", "Ø§Ù„Ø³Ø¨Ø¹ Ù…Ø³Ø§Ø¬Ø¯", "Ø¬Ø¨Ù„ Ø£Ø­Ø¯", "Ù…Ù‚Ø¨Ø±Ø© Ø§Ù„Ø¨Ù‚ÙŠØ¹",

        # --- Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª ---
        "Ù…Ø­Ø·Ø© Ø§Ù„Ù‚Ø·Ø§Ø±", "Ù‚Ø·Ø§Ø± Ø§Ù„Ø­Ø±Ù…ÙŠÙ†", "Ù…Ø·Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", "Ù…Ø·Ø§Ø± Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²",
        "Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ", "Ù…ÙˆÙ‚Ù Ù…ÙƒØ©", "Ù…ÙˆÙ‚Ù Ø¬Ø¯Ø©", "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù‡Ø¬Ø±Ø©", "Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª",

        # --- Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… ---
        "Ø¬Ø§Ù…Ø¹Ø© Ø·ÙŠØ¨Ø©", "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", "ÙƒÙ„ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ©", "Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù…ÙŠØ± Ù…Ù‚Ø±Ù†", 
        "ÙƒÙ„ÙŠØ§Øª Ø§Ù„Ø±ÙŠØ§Ù†", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…",

        # --- Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª ---
        "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ", "Ø§Ù„Ø­Ø±Ø³ Ø§Ù„ÙˆØ·Ù†ÙŠ", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ Ø³Ù„Ù…Ø§Ù†", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯", 
        "Ø§Ù„Ù…ÙˆØ§Ø³Ø§Ø©", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©", "Ù…Ø³ØªØ´ÙÙ‰ Ù…Ù…Ø§Ø±", "Ù…Ø³ØªØ´ÙÙ‰ Ø£Ø­Ø¯", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØ·Ù†ÙŠ",
        "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø¯Ø§Ø±", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø£Ù…Ù„", "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„ØµØ¯Ø±ÙŠØ©",

        # --- Ø§Ù„Ù…ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø£Ø³ÙˆØ§Ù‚ ---
        "Ø§Ù„Ù†ÙˆØ± Ù…ÙˆÙ„", "Ø§Ù„Ø±Ø§Ø´Ø¯ Ù…ÙˆÙ„", "Ø§Ù„Ø¹Ø§Ù„ÙŠØ© Ù…ÙˆÙ„", "Ù…Ù†Ø§Ø± Ù…ÙˆÙ„", "Ø³ÙˆÙ‚ Ø¨Ù„Ø§Ù„", "Ø³ÙˆÙ‚ Ø§Ù„ØºÙ†Ù…",
        "Ø³ÙˆÙ‚ Ø§Ù„Ø¯Ø®ÙŠÙ„", "Ø³ÙˆÙ‚ Ø§Ù„Ø®Ø¶Ø§Ø±", "Ø¨Ù†Ø¯Ø©", "Ø§Ù„Ø¹Ø«ÙŠÙ…", "Ø§Ù„Ø¯Ø§Ù†ÙˆØ¨", "Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¯ÙˆÙ„ÙŠ",

        # --- Ø§Ù„ÙÙ†Ø§Ø¯Ù‚ ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø­ÙŠÙˆÙŠØ© ---
        "Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©", "Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©", "Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©", "Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©", 
        "Ù…Ù…Ø´Ù‰ Ø§Ù„Ù‡Ø¬Ø±Ø©", "Ù…Ù…Ø´Ù‰ Ø§Ù„Ø¹Ø¨Ø§Ø³", "Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯", "Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡", "Ù…ØªÙ†Ø²Ù‡ Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡"
    ]
}

# --- 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ (Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ù„ØºÙˆÙŠ) ---

try:
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…Ø¹ ÙŠØªØ³Ø¹ Ù„Ù€ 1 Ø¥Ù„Ù‰ 20 Ø§ØªØµØ§Ù„ Ù…ØªØ²Ø§Ù…Ù†
    db_pool = psycopg2.pool.ThreadedConnectionPool(
        minconn=1, 
        maxconn=20, 
        dsn=DB_URL,
        sslmode='require' # Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„Ø±ÙŠÙ†Ø¯Ø±
    )
    print("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ù…Ø¬Ù…Ø¹ Ø§ØªØµØ§Ù„Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Connection Pool)")
except Exception as e:
    print(f"âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª: {e}")
    db_pool = None

# ==========================================
# 2. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Helper Functions)
# ==========================================

def get_db_connection():
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ø¢Ù…Ù† Ù…Ø¹ ÙØ­Øµ Ø­ÙŠÙˆÙŠØªÙ‡ (Health Check)"""
    global db_pool
    
    if db_pool is None:
        try:
            fixed_url = DB_URL.replace("postgres://", "postgresql://")
            db_pool = psycopg2.pool.ThreadedConnectionPool(1, 20, dsn=fixed_url, sslmode='require')
        except Exception as e:
            print(f"âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…Ø¹: {e}")
            return None

    try:
        conn = db_pool.getconn()
        
        # --- Ø§Ù„ÙØ­Øµ Ø§Ù„Ø­ÙŠÙˆÙŠ (Health Check) ---
        # Ù†Ù‚ÙˆÙ… Ø¨Ø¹Ù…Ù„ Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙØ§Ø±Øº Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø­ÙŠØ§Ù‹
        try:
            with conn.cursor() as tmp_cur:
                tmp_cur.execute('SELECT 1')
        except (psycopg2.OperationalError, psycopg2.InterfaceError):
            print("ðŸ”„ Ø§ÙƒØªØ´Ø§Ù Ø§ØªØµØ§Ù„ Ù…ÙŠØª ÙÙŠ Ø§Ù„Ù…Ø¬Ù…Ø¹ØŒ ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡...")
            db_pool.putconn(conn, close=True) # Ø§Ù„ØªØ®Ù„Øµ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªØ§Ù„Ù
            return db_pool.getconn()          # Ø¬Ù„Ø¨ Ø§ØªØµØ§Ù„ Ø¬Ø¯ÙŠØ¯ ÙˆÙ†Ø¸ÙŠÙ
            
        return conn
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø³Ø­Ø¨ Ø§ØªØµØ§Ù„: {e}")
        db_pool = None 
        return None

def release_db_connection(conn):
    if not conn:
        return
    try:
        if db_pool:
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…ÙØªÙˆØ­Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù„Ù…Ø¬Ù…Ø¹
            if not conn.closed:
                db_pool.putconn(conn)
            else:
                # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØºÙ„Ù‚Ø§Ù‹ Ø£ØµÙ„Ø§Ù‹ØŒ ÙÙ‚Ø· Ù†ØªØ¬Ø§Ù‡Ù„Ù‡ (Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø³ÙŠØªÙˆÙ„Ù‰ Ø§Ù„ØªØ¹ÙˆÙŠØ¶)
                pass
        else:
            conn.close()
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§ØªØµØ§Ù„: {e}")
        try: conn.close() 
        except: pass


# ==========================================
# 3. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Operations)
# ==========================================

async def update_db_silent(user_id, lat, lon):
    """ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¯ÙˆÙ† ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    conn = get_db_connection()
    if not conn: return

    try:
        def db_task():
            with conn.cursor() as cur:
                cur.execute(
                    "UPDATE users SET lat = %s, lon = %s, last_location_update = NOW() WHERE user_id = %s",
                    (lat, lon, user_id)
                )
                conn.commit()
        
        await asyncio.to_thread(db_task)
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø®Ù„ÙÙŠ: {e}")
    finally:
        release_db_connection(conn)

def init_db():
    """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…Ø¹ØŒ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŒ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ©"""
    global db_pool
    
    # 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if db_pool is None:
        try:
            db_pool = pool.SimpleConnectionPool(
                1, 15, # Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª (Ø§Ù„Ø£Ø¯Ù†Ù‰ ÙˆØ§Ù„Ø£Ù‚ØµÙ‰)
                dsn=DB_URL,
                sslmode='require'
            )
            print("âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ù…Ø¬Ù…Ø¹ Ø§ØªØµØ§Ù„Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.")
        except Exception as e:
            print(f"âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…Ø¹: {e}")
            return

    # 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¬Ù‡Ø²
    conn = get_db_connection()
    if not conn: 
        print("âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„.")
        return

    try:
        with conn.cursor() as cur:

            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ

            # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            cur.execute("""
                CREATE TABLE IF NOT EXISTS chat_logs (
                    log_id SERIAL PRIMARY KEY,
                    sender_id BIGINT,
                    receiver_id BIGINT,
                    message_content TEXT,
                    msg_type TEXT,
                    created_at TIMESTAMPTZ DEFAULT NOW()
                );
            """)

            cur.execute("""
                CREATE TABLE IF NOT EXISTS users (
                    user_id BIGINT PRIMARY KEY,
                    chat_id BIGINT,
                    role TEXT,
                    name TEXT,
                    phone TEXT,
                    car_info TEXT,
                    districts TEXT,
                    lat FLOAT DEFAULT 0.0,
                    lon FLOAT DEFAULT 0.0,
                    is_blocked BOOLEAN DEFAULT FALSE,
                    is_verified BOOLEAN DEFAULT FALSE,
                    subscription_expiry TIMESTAMPTZ,
                    balance FLOAT DEFAULT 0.0
                );
            """)
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±ØµÙŠØ¯ (Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
            cur.execute("ALTER TABLE users ADD COLUMN IF NOT EXISTS balance FLOAT DEFAULT 0.0;")
            conn.commit()
            # ... (Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ users)

            # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            cur.execute("""
                CREATE TABLE IF NOT EXISTS active_chats (
                    user_id BIGINT PRIMARY KEY,
                    partner_id BIGINT,
                    start_time TIMESTAMPTZ DEFAULT NOW()
                );
            """)
            conn.commit()

            print("âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©.")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
    finally:
        # Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø³ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø³ÙˆØ§Ø¡ Ù†Ø¬Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ ÙØ´Ù„
        # ÙˆÙ‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØ¶Ù…Ù† ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ù…Ø¬Ù…Ø¹ (Pool)
        release_db_connection(conn)



def normalize_text(text):
    """ØªÙ†Ø¸ÙŠÙ ÙˆØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø¯Ù‚Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª"""
    if not text: return ""

    # 1. ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØµØºÙŠØ± ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
    text = text.strip().lower()

    # 2. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ (ÙØªØ­Ø©ØŒ Ø¶Ù…Ø©ØŒ Ø¥Ù„Ø®)
    text = re.sub(r"[\u064B-\u0652]", "", text)

    # 3. ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø©
    replacements = {
        "Ø£": "Ø§", "Ø¥": "Ø§", "Ø¢": "Ø§",
        "Ø©": "Ù‡", "Ù‰": "ÙŠ", "Ø¦": "ÙŠ", "Ø¤": "Ùˆ"
    }
    for old, new in replacements.items():
        text = text.replace(old, new)

    # 4. Ø¥Ø²Ø§Ù„Ø© ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­Ø±ÙˆÙ (Ù…Ø´ÙˆØ§Ø§Ø§Ø§Ø§Ø± -> Ù…Ø´ÙˆØ§Ø±)
    text = re.sub(r'(.)\1+', r'\1', text)

    # 5. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù€ Ø§Ù„ØªØ¹Ø±ÙŠÙ Ù„Ø²ÙŠØ§Ø¯Ø© Ù…Ø±ÙˆÙ†Ø© Ø§Ù„Ø¨Ø­Ø«
    # Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø²Ø§Ù„Ø© "Ø§Ù„" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¬Ø¹Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø­Ø±ÙˆÙ (Ù…Ø«Ù„ Ø§Ù„Ø¹Ø²ÙŠØ²ÙŠØ© -> Ø¹Ø²ÙŠØ²ÙŠÙ‡)
    words = text.split()
    clean_words = []
    for w in words:
        if w.startswith("Ø§Ù„") and len(w) > 3:
            clean_words.append(w[2:])
        else:
            clean_words.append(w)

    return " ".join(clean_words)