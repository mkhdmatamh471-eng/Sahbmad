import re
import os
import asyncio

# --- 1. إصلاح تعريف الروابط والمتغيرات ---
# جلب الرابط من البيئة، وإذا لم يوجد نضع قيمة فارغة لتجنب الـ NameError

BOT_TOKEN = os.environ.get("BOT_TOKEN", "8498451295:AAGt1R7THllSjYtEe5hvIEPnPhRkS_iBcnU")


# قاموس إحداثيات أحياء ومعالم المدينة المنورة (خط العرض، خط الطول)
DISTRICT_COORDS = {
    # --- المعالم الرئيسية والمركزية ---
    "الحرم": (24.4672, 39.6112),
    "المسجد النبوي": (24.4672, 39.6112),
    "المنطقة المركزية": (24.4672, 39.6112),
    "المركزية": (24.4672, 39.6112),
    "مسجد قباء": (24.4391, 39.6172),
    "مسجد القبلتين": (24.4845, 39.5772),
    "الميقات": (24.4132, 39.5445),
    "ابيار علي": (24.4132, 39.5445),
    "أبيار علي": (24.4132, 39.5445),
    "ذو الحليفة": (24.4132, 39.5445),
    "سيد الشهداء": (24.5028, 39.6133),
    
    # --- الأحياء الرئيسية ---
    "العزيزية": (24.4385, 39.5398),
    "العوالي": (24.4420, 39.6380),
    "الخالدية": (24.4550, 39.5850),
    "الدعيثة": (24.4411, 39.5055),
    "الرانونا": (24.3980, 39.5820),
    "شوران": (24.4050, 39.6050),
    "سلطانة": (24.4880, 39.5810),
    "القبلتين": (24.4820, 39.5750),
    "الجرف": (24.5120, 39.5630),
    "العاقول": (24.4950, 39.7350),
    "باقدو": (24.4550, 39.6510),
    "الملك فهد": (24.4850, 39.6550),
    "الفيحاء": (24.4800, 39.6300),
    "الاسكان": (24.4350, 39.6500),
    "الإسكان": (24.4350, 39.6500),
    "حمراء الأسد": (24.3850, 39.5450),
    "الزهراء": (24.4750, 39.5950),
    "الربوة": (24.4950, 39.6150),
    "العنابس": (24.4710, 39.5910),
    "السيح": (24.4680, 39.5950),
    "العنبرية": (24.4590, 39.6000),
    "الشهداء": (24.5000, 39.6100),
    "الدويخله": (24.4600, 39.6450),
    "المبعوث": (24.4750, 39.6600),
    "الدويمة": (24.4380, 39.5950),
    
    # --- النقل والمواصلات ---
    "المطار": (24.5533, 39.7044),
    "مطار الأمير محمد بن عبدالعزيز": (24.5533, 39.7044),
    "محطة القطار": (24.4450, 39.6540),
    "قطار الحرمين": (24.4450, 39.6540),
    "سابتكو": (24.4610, 39.6020),
    "النقل الجماعي": (24.4610, 39.6020),
    
    # --- الجامعات ---
    "جامعة طيبة": (24.4841, 39.5448),
    "الجامعة الإسلامية": (24.4780, 39.5630),
    "جامعة الامير مقرن": (24.5050, 39.6600),
    "الكلية التقنية": (24.4350, 39.5200),
    
    # --- المولات والأسواق ---
    "النور مول": (24.4920, 39.5930),
    "الراشد مول": (24.4820, 39.5890),
    "العالية مول": (24.4450, 39.6120),
    "المنار مول": (24.4650, 39.5650),
    "مزايا مول": (24.4780, 39.6150),
    "سوق التمور": (24.4580, 39.6080),
    
    # --- المستشفيات ---
    "مستشفى الملك فهد": (24.4700, 39.5750),
    "مستشفى أحد": (24.5000, 39.6200),
    "المستشفى العسكري": (24.4300, 39.6400),
    "مستشفى الحرس": (24.5200, 39.6600),
    "مستشفى الولادة": (24.4800, 39.6500),
    "مستشفى الميقات": (24.4150, 39.5500),
    "المواساة": (24.5050, 39.6000),
    "الطب الدولي": (24.4550, 39.5900),
    "مستشفى الدار": (24.4350, 39.6150)
}

# نقطة افتراضية للمدينة المنورة (مركز المدينة) للكلمات العامة (مثل: عام، فندق، المخطط)
DEFAULT_MEDINA_COORD = (24.4672, 39.6112)

# --- 2. إعدادات الأحياء (المدينة المنورة) ---
CITIES_DISTRICTS = {
    "المدينة المنورة": [
        # --- الأحياء السكنية (تم إضافة الخليل والنصر والسكب والقصواء) ---
        "أبو مرخة", "أبيار علي", "الأسواف", "البخاري", "الإسكان", "البحر", 
        "البدراني", "الجمعة", "الجرف", "الحزام", "الحمراء", "الخاتم", "الخالدية", 
        "الدائرة", "الدائري", "الدويخله", "الدويمة", "الدعيثة", "الرانونا", "الرناونة", 
        "الربوة", "السيح", "الشروق", "الشرق", "الشهداء", "الشيبية", "الظاهرة", 
        "العاقول", "العالية", "العوالي", "العريض", "العزيزية", "العصبة", 
        "العنابس", "العنبرية", "العيون", "الفتح", "القبلتين", "القارات", "المبعوث", 
        "المطار", "المغيسله", "الملك فهد", "الملك فيصل", "المناخة", "المصانع", 
        "النور", "النبلاء", "النقيع", "النقمي", "الهجرة", "الواحة", "الوادي", 
        "بئر الماشي", "بئر عثمان", "باقدو", "بني حارثة", "بني ظفر", "تلال علي", 
        "تلال", "حمراء الأسد", "دفاع", "ذو الحليفة", "رهط", "سيد الشهداء", 
        "سلطانة", "سكة الحديد", "السقيا", "شظاة", "شوران", "عروة", "قباء", 
        "قربان", "مخطط التلال", "مهزور", "وعيرة", "العصيبي", "تلعة الهبوب", 
        "الزهراء", "الفيحاء", "المنار", "سكن الحرس", "السديري", "المطار القديم",
        "السكب", "الورود", "الراية", "القصواء", "الهدى", "الروابي", "الريان",
        "الجابرة", "الرويعي", "المطار الجديد", "المزيني", "المعذر", 
        "الخليل", "حي الخليل", "النصر", "حي النصر", # تم الإضافة هنا
        "كتانة", "البركة", "الجسر", "المخطط", "حي الملك فهد", "حي المطار",

        # --- المعالم والمرافق الحيوية ---
        "الحرم", "المسجد النبوي", "مسجد قباء", "مسجد القبلتين", "الميقات", "ابيار علي",
        "محطة القطار", "قطار الحرمين", "المحطة", "سابتكو", "النقل الجماعي",
        "جامعة طيبة", "الجامعة الإسلامية", "الكلية التقنية", "جامعة الامير مقرن",

        # --- المولات والأسواق ---
        "النور مول", "الراشد مول", "العالية مول", "المنار مول", "مزايا مول", 
        "توب تن", "سوق الخضار", "سوق التمور", "الحجاز مول", "سوق البدر",

        # --- المستشفيات ---
        "مستشفى الملك فهد", "مستشفى أحد", "المستشفى العسكري", "مستشفى الحرس",
        "مستشفى الولادة", "مستشفى الميقات", "المواساة", "مستشفى الدار", "الطب الدولي",

        # --- المناطق المركزية ---
        "المنطقة المركزية", "المركزية", "باب السلام", "باب المجيدي", "فندق", "أجنحة"
    ]
}

# --- 3. دالة معالجة النصوص (المحسنة) ---
def normalize_text(text):
    """تنظيف وتوحيد النصوص العربية لزيادة دقة البحث"""
    if not text: return ""
    text = text.strip().lower()
    text = re.sub(r"[\u064B-\u0652]", "", text) # إزالة التشكيل
    
    replacements = {
        "أ": "ا", "إ": "ا", "آ": "ا",
        "ة": "ه", "ى": "ي", "ئ": "ي", "ؤ": "و"
    }
    for old, new in replacements.items():
        text = text.replace(old, new)
    
    # إزالة ال التعريف من الكلمات الطويلة لزيادة مطابقة الأحياء
    words = text.split()
    clean_words = [w[2:] if w.startswith("ال") and len(w) > 3 else w for w in words]
    return " ".join(clean_words)

# ملاحظة: تم حذف دوال قاعدة البيانات (init_db, pool) لأن الرادار لا يحتاجها 
# ليعمل الملف كـ Config صافي وخفيف.
